import {
    Assessment as AssessmentIcon,
    AttachMoney as AttachMoneyIcon,
    Close as CloseIcon,
    GetApp as GetAppIcon,
    Home as HomeIcon,
    People as PeopleIcon,
    Restaurant as RestaurantIcon,
    Settings as SettingsIcon,
    TrendingUp as TrendingUpIcon
} from '@mui/icons-material';
import {
    Box,
    Button,
    Card,
    CardActionArea,
    CardContent,
    Container,
    Dialog,
    DialogActions,
    DialogContent,
    DialogTitle,
    TextField,
    Typography
} from '@mui/material';
import { format } from 'date-fns';
import React, { useEffect, useState } from 'react';
import { useApp } from '../contexts/AppContext';
import {
    exportBillingData,
    exportComprehensiveReport,
    exportMonthlyReport,
    exportRatingAnalysis
} from '../utils/csvExport';
import {
    calculateRevenue
} from '../utils/statistics';

interface AdminPanelProps {
    onNavigateToUserManagement: () => void;
    onNavigateToStatistics: () => void;
    onNavigateToSettings: () => void;
    onNavigateToDailyReport: () => void;
    onNavigateToWeeklyReport: () => void;
    onNavigateToMonthlyReport: () => void;
    onNavigateToBillingReport: () => void;
    onClose: () => void;
}

interface AdminCardProps {
    title: string;
    description: string;
    icon: React.ReactNode;
    onClick: () => void;
    color: string;
}

const AdminCard: React.FC<AdminCardProps> = ({ title, description, icon, onClick, color }) => (
    <Card sx={{ borderRadius: '16px' }}>
        <CardActionArea
            onClick={onClick}
            sx={{
                p: 3,
                textAlign: 'center',
                transition: 'all 0.3s ease',
                '&:hover': {
                    transform: 'scale(1.05)',
                    boxShadow: 6,
                }
            }}
        >
            <Box sx={{ color }}>{icon}</Box>
            <Typography variant="h5" sx={{ fontWeight: 600, mb: 1 }}>
                {title}
            </Typography>
            <Typography variant="body1" color="text.secondary">
                {description}
            </Typography>
        </CardActionArea>
    </Card>
);

const AdminPanel: React.FC<AdminPanelProps> = ({
    onNavigateToUserManagement,
    onNavigateToStatistics,
    onNavigateToSettings,
    onNavigateToDailyReport,
    onNavigateToWeeklyReport,
    onNavigateToMonthlyReport,
    onNavigateToBillingReport,
    onClose,
}) => {
    const { state, setRequireAdminAuth } = useApp();
    const [accessDialog, setAccessDialog] = useState(true);
    const [accessCode, setAccessCode] = useState('');
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [currentMonthRevenue, setCurrentMonthRevenue] = useState(0);

    // 簡易認証（実際の運用では設定画面で変更可能）
    const ADMIN_CODE = '1234';

    // 認証処理
    const handleAuthentication = () => {
        if (accessCode === ADMIN_CODE) {
            setIsAuthenticated(true);
            setAccessDialog(false);
            setRequireAdminAuth(false);
        } else {
            alert('パスワードが正しくありません');
        }
    };

    // 統計データの計算
    useEffect(() => {
        if (isAuthenticated) {
            const revenueData = calculateRevenue(state.mealRecords, 'monthly');
            const thisMonthRevenue = revenueData.find(r =>
                r.period === format(new Date(), 'yyyy-MM')
            )?.revenue || 0;

            setCurrentMonthRevenue(thisMonthRevenue);
        }
    }, [isAuthenticated, state.mealRecords, state.users]);

    // CSV出力ハンドラー
    const handleExportCSV = (type: string) => {
        try {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;

            switch (type) {
                case 'comprehensive':
                    exportComprehensiveReport(state.mealRecords, state.users, []);
                    break;
                case 'monthly':
                    exportMonthlyReport(state.mealRecords, state.users, currentYear, currentMonth);
                    break;
                case 'rating':
                    exportRatingAnalysis(state.mealRecords, []);
                    break;
                case 'billing':
                    exportBillingData(state.mealRecords, state.users, currentYear, currentMonth);
                    break;
            }
        } catch (error) {
            alert(`CSV出力エラー: ${error}`);
        }
    };

    // 認証ダイアログ
    if (state.requireAdminAuth && !isAuthenticated) {
        return (
            <Dialog
                open={accessDialog}
                onClose={onClose}
                maxWidth="sm"
                fullWidth
                PaperProps={{
                    sx: { borderRadius: '16px', p: 2 }
                }}
            >
                <DialogTitle sx={{ textAlign: 'center', fontSize: '1.75rem', fontWeight: 700 }}>
                    管理者認証
                </DialogTitle>
                <DialogContent sx={{ textAlign: 'center', py: 3 }}>
                    <Typography variant="h5" sx={{ mb: 3 }}>
                        管理機能にアクセスするためのパスワードを入力してください
                    </Typography>
                    <TextField
                        fullWidth
                        type="password"
                        label="パスワード"
                        value={accessCode}
                        onChange={(e) => setAccessCode(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleAuthentication()}
                        sx={{
                            '& .MuiInputBase-root': {
                                fontSize: '1.5rem',
                                minHeight: '60px',
                            },
                        }}
                    />
                </DialogContent>
                <DialogActions sx={{ justifyContent: 'center', gap: 2, p: 3 }}>
                    <Button
                        onClick={onClose}
                        variant="outlined"
                        size="large"
                        startIcon={<CloseIcon />}
                    >
                        キャンセル
                    </Button>
                    <Button
                        onClick={handleAuthentication}
                        variant="contained"
                        size="large"
                        disabled={!accessCode}
                    >
                        認証
                    </Button>
                </DialogActions>
            </Dialog>
        );
    }

    return (
        <Container maxWidth="lg" sx={{ py: 4 }}>
            {/* ヘッダー */}
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 4 }}>
                <Typography variant="h2" component="h1" sx={{ color: 'primary.main' }}>
                    🛠️ 管理画面
                </Typography>
                <Button
                    variant="contained"
                    startIcon={<HomeIcon />}
                    onClick={onClose}
                    size="large"
                    sx={{
                        minHeight: '60px',
                        fontSize: '1.2rem',
                        fontWeight: 600,
                        borderRadius: '12px',
                        px: 3
                    }}
                >
                    メイン画面に戻る
                </Button>
            </Box>

            {/* 統計カード */}
            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 3, mb: 4 }}>
                <Box sx={{ minWidth: '250px', flex: 1 }}>
                    <Card sx={{ borderRadius: '16px', backgroundColor: 'primary.light' }}>
                        <CardContent sx={{ textAlign: 'center', p: 3 }}>
                            <PeopleIcon sx={{ fontSize: '3rem', color: 'primary.main', mb: 1 }} />
                            <Typography variant="h3" sx={{ fontWeight: 700, color: 'primary.main' }}>
                                {state.users.filter(u => u.isActive).length}
                            </Typography>
                            <Typography variant="h6">登録利用者</Typography>
                        </CardContent>
                    </Card>
                </Box>

                <Box sx={{ minWidth: '250px', flex: 1 }}>
                    <Card sx={{ borderRadius: '16px', backgroundColor: 'success.light' }}>
                        <CardContent sx={{ textAlign: 'center', p: 3 }}>
                            <RestaurantIcon sx={{ fontSize: '3rem', color: 'success.main', mb: 1 }} />
                            <Typography variant="h3" sx={{ fontWeight: 700, color: 'success.main' }}>
                                {state.mealRecords.length}
                            </Typography>
                            <Typography variant="h6">総利用回数</Typography>
                        </CardContent>
                    </Card>
                </Box>

                <Box sx={{ minWidth: '250px', flex: 1 }}>
                    <Card sx={{ borderRadius: '16px', backgroundColor: 'warning.light' }}>
                        <CardContent sx={{ textAlign: 'center', p: 3 }}>
                            <AttachMoneyIcon sx={{ fontSize: '3rem', color: 'warning.main', mb: 1 }} />
                            <Typography variant="h3" sx={{ fontWeight: 700, color: 'warning.main' }}>
                                ¥{currentMonthRevenue.toLocaleString()}
                            </Typography>
                            <Typography variant="h6">今月の売上</Typography>
                        </CardContent>
                    </Card>
                </Box>

                <Box sx={{ minWidth: '250px', flex: 1 }}>
                    <Card sx={{ borderRadius: '16px', backgroundColor: 'info.light' }}>
                        <CardContent sx={{ textAlign: 'center', p: 3 }}>
                            <TrendingUpIcon sx={{ fontSize: '3rem', color: 'info.main', mb: 1 }} />
                            <Typography variant="h3" sx={{ fontWeight: 700, color: 'info.main' }}>
                                {state.mealRecords.length > 0
                                    ? Math.round((state.mealRecords.reduce((sum, r) => sum + r.rating, 0) / state.mealRecords.length) * 100) / 100
                                    : 0
                                }
                            </Typography>
                            <Typography variant="h6">平均評価</Typography>
                        </CardContent>
                    </Card>
                </Box>
            </Box>

            {/* 管理機能メニュー */}
            <Typography variant="h4" sx={{ mb: 3, fontWeight: 600 }}>
                管理機能
            </Typography>
            <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 3, mb: 4 }}>
                <AdminCard
                    title="利用者管理"
                    description="利用者の登録、編集、削除"
                    icon={<PeopleIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToUserManagement}
                    color="primary.main"
                />
                <AdminCard
                    title="統計データ"
                    description="利用状況のグラフやサマリー"
                    icon={<AssessmentIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToStatistics}
                    color="success.main"
                />
                <AdminCard
                    title="設定"
                    description="アプリケーションの動作設定"
                    icon={<SettingsIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToSettings}
                    color="info.main"
                />
            </Box>

            {/* レポート機能 */}
            <Typography variant="h4" sx={{ mb: 3, fontWeight: 600 }}>
                レポート機能
            </Typography>
            <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 3, mb: 4 }}>
                <AdminCard
                    title="当日注文レポート"
                    description="本日の注文状況を出力"
                    icon={<GetAppIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToDailyReport}
                    color="secondary.main"
                />
                <AdminCard
                    title="週次レポート"
                    description="週間ごとの利用状況"
                    icon={<GetAppIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToWeeklyReport}
                    color="secondary.main"
                />
                <AdminCard
                    title="月次レポート"
                    description="月間ごとの利用状況"
                    icon={<GetAppIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToMonthlyReport}
                    color="secondary.main"
                />
                <AdminCard
                    title="料金計算レポート"
                    description="利用者ごとの料金計算"
                    icon={<AttachMoneyIcon sx={{ fontSize: '3rem' }} />}
                    onClick={onNavigateToBillingReport}
                    color="warning.main"
                />
            </Box>

            {/* CSV出力メニュー */}
            <Typography variant="h4" sx={{ mb: 3, fontWeight: 600 }}>
                データ出力
            </Typography>

            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 3 }}>
                <Box sx={{ minWidth: '200px', flex: 1 }}>
                    <Button
                        variant="contained"
                        fullWidth
                        size="large"
                        onClick={() => handleExportCSV('comprehensive')}
                        startIcon={<GetAppIcon />}
                        sx={{ minHeight: '80px', fontSize: '1.2rem' }}
                    >
                        統合レポート
                    </Button>
                </Box>

                <Box sx={{ minWidth: '200px', flex: 1 }}>
                    <Button
                        variant="contained"
                        fullWidth
                        size="large"
                        onClick={() => handleExportCSV('monthly')}
                        startIcon={<GetAppIcon />}
                        sx={{ minHeight: '80px', fontSize: '1.2rem' }}
                    >
                        月次レポート
                    </Button>
                </Box>

                <Box sx={{ minWidth: '200px', flex: 1 }}>
                    <Button
                        variant="contained"
                        fullWidth
                        size="large"
                        onClick={() => handleExportCSV('rating')}
                        startIcon={<GetAppIcon />}
                        sx={{ minHeight: '80px', fontSize: '1.2rem' }}
                    >
                        評価分析
                    </Button>
                </Box>

                <Box sx={{ minWidth: '200px', flex: 1 }}>
                    <Button
                        variant="contained"
                        fullWidth
                        size="large"
                        onClick={() => handleExportCSV('billing')}
                        startIcon={<GetAppIcon />}
                        sx={{ minHeight: '80px', fontSize: '1.2rem' }}
                    >
                        請求データ
                    </Button>
                </Box>
            </Box>
        </Container>
    );
};

export default AdminPanel; 